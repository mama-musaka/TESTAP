<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8">
  <title>Тестова система</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Specific layout for the landing page */
    .actions { 
        margin-top: 25px; 
        display: flex; 
        flex-wrap: wrap; 
        gap: 15px; 
        justify-content: flex-start;
    }
    
    .copied { 
        color: #06d6a0; 
        font-weight: bold; 
        opacity: 0; 
        transition: opacity 0.5s; 
        font-size: 14px; 
        align-self: center;
    }
    
    .btn-group-main {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 50px;
        flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Тестова система</h1>

    <div class="btn-group-main">
        <a href="create.html" class="btn create">+ Създай нов тест</a>
        <a href="dashboard.html" class="btn dashboard">Учителски дашборд</a>
    </div>

    <div style="margin-top:60px; text-align: left;">
      <h2>Създадени тестове</h2>
      <div id="list"></div>
      <p id="empty" style="text-align:center; font-size:20px; margin-top:50px; display:none; opacity: 0.6;">
        Все още няма създадени тестове.
      </p>
    </div>
  </div>

  <script>
    function shareTest(id) {
      const link = window.location.origin + window.location.pathname.replace(/index\.html.*$/, '') + 'take.html?id=' + id;
      navigator.clipboard.writeText(link).then(() => {
        const btn = event.target;
        const msg = btn.nextElementSibling; 
        if(msg && msg.classList.contains('copied')) {
            msg.style.opacity = 1;
            setTimeout(() => msg.style.opacity = 0, 2000);
        }
      }).catch(() => {
        prompt('Копирай този линк:', link);
      });
    }

    fetch('/api/tests')
      .then(r => r.json())
      .then(tests => {
        if (!tests || tests.length === 0) {
          document.getElementById('empty').style.display = 'block';
          return;
        }

        const html = tests.map(t => `
          <div class="test-card">
            <h3>${t.title}</h3>
            <p>Въпроси: <strong>${t.question_count}</strong></p>

            <div class="actions">
              <a href="take.html?id=${t.id}" class="btn green" style="margin:0">Решаване</a>
              <button onclick="shareTest(${t.id})" class="share-btn" style="margin:0">Сподели</button>
              <span class="copied">Копирано!</span>
              <button onclick="if(confirm('Изтриване на „${t.title}“?')) fetch('/api/tests/${t.id}',{method:'DELETE'}).then(()=>location.reload())"
                      class="btn red" style="margin:0; margin-left:auto;">Изтрий</button>
            </div>
          </div>
        `).join('');

        document.getElementById('list').innerHTML = html;
      })
      .catch(() => {
        document.getElementById('list').innerHTML = '<p style="color:red; text-align:center;">Грешка при зареждане!</p>';
      });

    // Dark Mode Toggle
    if (localStorage.getItem('dark') === 'true') document.body.classList.add('dark');
    document.addEventListener('DOMContentLoaded', () => {
      let btn = document.getElementById('global-dark-toggle');
      if (!btn) {
        btn = document.createElement('button');
        btn.id = 'global-dark-toggle';
        btn.textContent = document.body.classList.contains('dark') ? '☀' : '☾';
        btn.style.cssText = 'position:fixed; top:20px; right:20px; z-index:9999; background:rgba(0,0,0,0.5); width:40px; height:40px; padding:0; border-radius:50%; font-size:20px; backdrop-filter:blur(5px); margin:0; display:flex; align-items:center; justify-content:center; box-shadow:none;';
        document.body.appendChild(btn);
        btn.onclick = () => {
          document.body.classList.toggle('dark');
          localStorage.setItem('dark', document.body.classList.contains('dark'));
          btn.textContent = document.body.classList.contains('dark') ? '☀' : '☾';
        };
      }
    });
  </script>
</body>
</html>