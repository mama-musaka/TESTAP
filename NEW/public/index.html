<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8">
  <title>–¢–∞–±–ª–æ - –¢–µ—Å—Ç–æ–≤–∞ –°–∏—Å—Ç–µ–º–∞</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <script>
      const user = JSON.parse(localStorage.getItem('user'));
      if (!user) window.location.href = 'login.html';
  </script>

  <nav class="top-nav">
    <div class="brand">
        <div class="brand-icon">üìä</div>
        <span>–¢–µ—Å—Ç–æ–≤–∞ —Å–∏—Å—Ç–µ–º–∞</span>
    </div>
    <div style="display:flex; align-items:center; gap:15px;">
        <span id="user-display" style="font-weight:bold;"></span>
        <button onclick="logout()" class="btn red" style="padding:5px 15px; font-size:12px;">–ò–∑—Ö–æ–¥</button>
    </div>
  </nav>

  <div class="container">
    
    <div class="dashboard-grid">
        <div class="card graph-card" id="teacher-stats">
            <h2 style="text-align: center; color: var(--primary);">üèÜ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞ –∫–ª–∞—Å–æ–≤–µ—Ç–µ</h2>
            <div class="chart-container"><canvas id="classChart"></canvas></div>
        </div>

        <div class="menu-column">
            <div class="card action-card" id="teacher-menu" style="display:none;">
                <h3>üë®‚Äçüè´ –£—á–∏—Ç–µ–ª—Å–∫–∏ –ø–∞–Ω–µ–ª</h3>
                <div class="btn-group-vertical">
                    <a href="create.html" class="btn btn-primary" style="width:100%;">‚úèÔ∏è –°—ä–∑–¥–∞–π —Ç–µ—Å—Ç</a>
                    <a href="dashboard.html" class="btn dashboard" style="width:100%;">üìù –ü—Ä–æ–≤–µ—Ä–∫–∞ & –û—Ü–µ–Ω–∫–∏</a>
                    <button id="theme-btn-teacher" class="btn" style="width:100%; background:#34495e;">üåô –°–º–µ–Ω–∏ —Ç–µ–º–∞</button>
                </div>
            </div>

            <div class="card action-card" id="student-menu" style="display:none;">
                <h3>üëã –ó–¥—Ä–∞–≤–µ–π, <span id="s-name"></span></h3>
                <p>–ö–ª–∞—Å: <strong id="s-class"></strong></p>
                <div class="btn-group-vertical">
                    <button onclick="document.getElementById('test-list').scrollIntoView({behavior:'smooth'})" class="btn green" style="width:100%;">‚ñ∂Ô∏è –ù–∞–º–µ—Ä–∏ –¢–µ—Å—Ç</button>
                    <button id="theme-btn-student" class="btn" style="width:100%; background:#34495e;">üåô –°–º–µ–Ω–∏ —Ç–µ–º–∞</button>
                </div>
            </div>
        </div>
    </div>

    <div id="test-list" style="margin-top: 50px;">
        <h2 style="border-bottom: 2px solid var(--primary); padding-bottom: 10px;">üìã –ê–∫—Ç–∏–≤–Ω–∏ —Ç–µ—Å—Ç–æ–≤–µ</h2>
        <div id="list">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</div>
    </div>

  </div>

  <script>
    document.getElementById('user-display').textContent = user.full_name || user.username;
    
    // Setup UI based on role
    if (user.role === 'student') {
        document.getElementById('student-menu').style.display = 'block';
        document.getElementById('s-name').textContent = user.full_name;
        document.getElementById('s-class').textContent = user.student_class;
        document.getElementById('teacher-stats').style.display = 'none';
        document.querySelector('.dashboard-grid').style.gridTemplateColumns = '1fr'; 
    } else {
        document.getElementById('teacher-menu').style.display = 'block';
        fetch('/api/submissions').then(r=>r.json()).then(setupChart);
    }

    // THEME TOGGLE LOGIC
    function toggleTheme() {
        document.body.classList.toggle('dark');
        localStorage.setItem('dark', document.body.classList.contains('dark'));
    }
    // Attach to both buttons just in case
    document.getElementById('theme-btn-student').onclick = toggleTheme;
    document.getElementById('theme-btn-teacher').onclick = toggleTheme;
    
    // Apply saved theme
    if (localStorage.getItem('dark') === 'true') document.body.classList.add('dark');

    function logout() {
        localStorage.removeItem('user');
        window.location.href = 'login.html';
    }

    // Load Tests
    fetch('/api/tests').then(r => r.json()).then(tests => {
        const list = document.getElementById('list');
        if (!tests.length) { list.innerHTML = '<p style="text-align:center;">–ù—è–º–∞ —Ç–µ—Å—Ç–æ–≤–µ.</p>'; return; }

        list.innerHTML = tests.map(t => `
          <div class="test-card">
            <div>
                <h3 style="margin:0; color:var(--primary);">${t.title}</h3>
                <span class="badge">–í—ä–ø—Ä–æ—Å–∏: ${t.question_count}</span>
            </div>
            <div class="actions">
              ${user.role === 'student' 
                  ? `<a href="take.html?id=${t.id}" class="btn green">–†–µ—à–∞–≤–∞–Ω–µ</a>` 
                  : `<button onclick="deleteTest(${t.id})" class="btn red">–ò–∑—Ç—Ä–∏–π</button>` 
              }
            </div>
          </div>
        `).join('');
    });

    function deleteTest(id) {
        if(confirm('–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ?')) fetch(`/api/tests/${id}`,{method:'DELETE'}).then(()=>location.reload());
    }

    function setupChart(data) {
        if(!data.length) return;
        const classStats = {};
        data.forEach(s => {
            const c = (s.studentClass || 'N/A').toUpperCase();
            const g = parseFloat(s.manualGrade || s.autoGrade);
            if(!classStats[c]) classStats[c] = {t:0, c:0};
            classStats[c].t+=g; classStats[c].c++;
        });
        
        const ctx = document.getElementById('classChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(classStats),
                datasets: [{
                    label: '–£—Å–ø–µ—Ö',
                    data: Object.keys(classStats).map(k => (classStats[k].t/classStats[k].c).toFixed(2)),
                    backgroundColor: '#4a90e2'
                }]
            }
        });
    }
  </script>
</body>
</html>