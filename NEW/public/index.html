<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8">
  <title>–¢–∞–±–ª–æ - –¢–µ—Å—Ç–æ–≤–∞ –°–∏—Å—Ç–µ–º–∞</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <nav class="top-nav">
    <div class="brand">
        <div class="brand-icon">üìä</div>
        <span>–¢–µ—Å—Ç–æ–≤–∞ —Å–∏—Å—Ç–µ–º–∞</span>
    </div>
    <button id="theme-toggle" class="btn" style="background:transparent; border:1px solid rgba(255,255,255,0.3);">üåô</button>
  </nav>

  <div class="container">
    
    <div class="dashboard-grid">
        <div class="card graph-card">
            <h2 style="text-align: center; color: var(--primary);">üèÜ –°—Ä–µ–¥–µ–Ω —É—Å–ø–µ—Ö –ø–æ –∫–ª–∞—Å–æ–≤–µ</h2>
            <div class="chart-container">
                <canvas id="classChart"></canvas>
            </div>
        </div>

        <div class="menu-column">
            <div class="card action-card">
                <h3>üë®‚Äçüè´ –£—á–∏—Ç–µ–ª—Å–∫–∏ –ø–∞–Ω–µ–ª</h3>
                <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–µ –∏ –æ—Ü–µ–Ω—è–≤–∞–Ω–µ</p>
                <div class="btn-group-vertical">
                    <a href="create.html" class="btn btn-primary" style="width:100%; text-align:center;">‚úèÔ∏è –°—ä–∑–¥–∞–π –Ω–æ–≤ —Ç–µ—Å—Ç</a>
                    <a href="dashboard.html" class="btn dashboard" style="width:100%; text-align:center;">üìù –ü—Ä–æ–≤–µ—Ä–∫–∞ & –û—Ü–µ–Ω–∫–∏</a>
                </div>
            </div>
        </div>
    </div>

    <div id="test-list" style="margin-top: 50px;">
        <h2 style="border-bottom: 2px solid var(--primary); padding-bottom: 10px;">üìã –ê–∫—Ç–∏–≤–Ω–∏ —Ç–µ—Å—Ç–æ–≤–µ</h2>
        <div id="list">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</div>
        <div id="empty" style="display:none; text-align:center; padding:40px; color:#888;">
            –ù—è–º–∞ –∞–∫—Ç–∏–≤–Ω–∏ —Ç–µ—Å—Ç–æ–≤–µ –≤ –º–æ–º–µ–Ω—Ç–∞.
        </div>
    </div>

  </div>

  <script>
    // 1. Fetch Data and Setup Dashboard
    Promise.all([
        fetch('/api/tests').then(r => r.json()),
        fetch('/api/submissions').then(r => r.json())
    ]).then(([tests, submissions]) => {
        setupTestList(tests);
        setupChart(submissions);
    }).catch(err => console.error("Error loading data:", err));

    // --- CHART LOGIC ---
    function setupChart(data) {
        if (!data || data.length === 0) {
            document.querySelector('.chart-container').innerHTML = '<p style="text-align:center; padding:50px; opacity:0.6;">–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤—Å–µ –æ—â–µ.</p>';
            return;
        }

        const classStats = {}; 

        data.forEach(sub => {
            const className = (sub.studentClass || '–ë–µ–∑ –∫–ª–∞—Å').toUpperCase().trim();
            const grade = parseFloat(sub.manualGrade && sub.manualGrade !== '‚Äî' ? sub.manualGrade : sub.autoGrade);
            
            if (!classStats[className]) classStats[className] = { total: 0, count: 0 };
            classStats[className].total += grade;
            classStats[className].count += 1;
        });

        const labels = [];
        const averages = [];
        const backgroundColors = [];

        Object.keys(classStats).forEach(cls => {
            const avg = classStats[cls].total / classStats[cls].count;
            labels.push(cls);
            averages.push(avg.toFixed(2));
            
            if(avg >= 5.50) backgroundColors.push('#2ecc71'); // Green
            else if(avg >= 4.50) backgroundColors.push('#3498db'); // Blue
            else if(avg >= 3.50) backgroundColors.push('#f1c40f'); // Yellow
            else backgroundColors.push('#e74c3c'); // Red
        });

        const ctx = document.getElementById('classChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: '–°—Ä–µ–¥–µ–Ω –£—Å–ø–µ—Ö',
                    data: averages,
                    backgroundColor: backgroundColors,
                    borderWidth: 0,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 6 }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    // --- TEST LIST LOGIC ---
    function setupTestList(tests) {
        if (!tests || tests.length === 0) {
            document.getElementById('list').innerHTML = '';
            document.getElementById('empty').style.display = 'block';
            return;
        }

        const html = tests.map(t => `
          <div class="test-card" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px;">
            <div>
                <h3 style="margin:0 0 5px 0; color:var(--primary); font-size:1.4rem;">${t.title}</h3>
                <span class="badge">–í—ä–ø—Ä–æ—Å–∏: ${t.question_count}</span>
            </div>
            <div class="actions">
              <a href="take.html?id=${t.id}" class="btn green">–†–µ—à–∞–≤–∞–Ω–µ</a>
              <button onclick="shareTest(${t.id})" class="share-btn">–°–ø–æ–¥–µ–ª–∏</button>
              <button onclick="if(confirm('–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —Ç–µ—Å—Ç–∞?')) fetch('/api/tests/${t.id}',{method:'DELETE'}).then(()=>location.reload())" 
                      class="btn red">–ò–∑—Ç—Ä–∏–π</button>
            </div>
          </div>
        `).join('');
        document.getElementById('list').innerHTML = html;
    }

    function shareTest(id) {
        const link = window.location.origin + window.location.pathname.replace(/index\.html.*$/, '') + 'take.html?id=' + id;
        navigator.clipboard.writeText(link)
            .then(() => alert('–õ–∏–Ω–∫—ä—Ç –µ –∫–æ–ø–∏—Ä–∞–Ω –≤ –∫–ª–∏–ø–±–æ—Ä–¥–∞!'))
            .catch(() => prompt('–ö–æ–ø–∏—Ä–∞–π—Ç–µ –ª–∏–Ω–∫–∞:', link));
    }

    if (localStorage.getItem('dark') === 'true') document.body.classList.add('dark');
    document.getElementById('theme-toggle').onclick = () => {
        document.body.classList.toggle('dark');
        localStorage.setItem('dark', document.body.classList.contains('dark'));
    };
  </script>
</body>
</html>