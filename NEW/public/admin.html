<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8">
  <title>–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª</title>
  <link rel="stylesheet" href="style.css">
  <script>
      const user = JSON.parse(localStorage.getItem('user'));
      if(!user || user.role !== 'admin') {
          alert('–°–∞–º–æ –∑–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∏!');
          window.location.href = 'index.html';
      }
  </script>
  <style>
      /* Two Column Admin Layout */
      .admin-layout { display: grid; grid-template-columns: 1fr 2fr; gap: 25px; }
      @media (max-width: 800px) { .admin-layout { grid-template-columns: 1fr; } }
      
      .edit-form { background: #fdfdfd; padding: 20px; border-radius: 12px; border: 2px solid #e0e0e0; }
      body.dark .edit-form { background: #21262d; border-color: #30363d; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üõ°Ô∏è –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª</h1>
    
    <div class="admin-layout">
        
        <div class="card">
            <h3 id="form-title">‚ûï –î–æ–±–∞–≤–∏ / –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</h3>
            <form id="userForm" class="edit-form">
                <input type="hidden" id="userId">
                
                <label>–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ –∏–º–µ</label>
                <input type="text" id="username" required>
                
                <label>–ü–∞—Ä–æ–ª–∞ <small>(–æ—Å—Ç–∞–≤–∏ –ø—Ä–∞–∑–Ω–æ –∞–∫–æ –Ω–µ –ø—Ä–æ–º–µ–Ω—è—à)</small></label>
                <input type="text" id="password" placeholder="–ù–æ–≤–∞ –ø–∞—Ä–æ–ª–∞">
                
                <label>–†–æ–ª—è</label>
                <select id="role" onchange="toggleFields()">
                    <option value="student">–£—á–µ–Ω–∏–∫</option>
                    <option value="teacher">–£—á–∏—Ç–µ–ª</option>
                    <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                </select>
                
                <div id="nameField">
                    <label>–ò–º–µ –∏ –§–∞–º–∏–ª–∏—è</label>
                    <input type="text" id="fullName">
                </div>
                
                <div id="classField">
                    <label>–ö–ª–∞—Å</label>
                    <input type="text" id="studentClass">
                </div>

                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button type="submit" class="btn green" style="width:100%;">–ó–∞–ø–∞–∑–∏</button>
                    <button type="button" class="btn red" onclick="resetForm()" style="width:100%;">–ò–∑—á–∏—Å—Ç–∏</button>
                </div>
            </form>
            
            <hr style="margin: 30px 0; opacity: 0.3;">
            
            <h3>üõ†Ô∏è –ë—ä—Ä–∑–∏ –≤—Ä—ä–∑–∫–∏</h3>
            <div class="btn-group-vertical">
                <a href="index.html" class="btn back-btn" style="margin:0;">üè† –ù–∞—á–∞–ª–æ</a>
                <a href="create.html" class="btn btn-primary" style="margin:0;">‚úèÔ∏è –°—ä–∑–¥–∞–π –¢–µ—Å—Ç</a>
                <a href="dashboard.html" class="btn dashboard" style="margin:0;">üìù –û—Ü–µ–Ω—è–≤–∞–Ω–µ</a>
            </div>
        </div>

        <div class="card">
            <h3>üë• –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ –Ω–∞ —Å–∏—Å—Ç–µ–º–∞—Ç–∞</h3>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª</th>
                            <th>–ò–º–µ</th>
                            <th>–†–æ–ª—è</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="userTable"></tbody>
                </table>
            </div>
        </div>
    </div>
  </div>

  <script>
    // 1. Load Users
    function loadUsers() {
        fetch('/api/users')
            .then(r => r.json())
            .then(users => {
                const tbody = document.getElementById('userTable');
                tbody.innerHTML = users.map(u => `
                    <tr>
                        <td>${u.id}</td>
                        <td><strong>${u.username}</strong></td>
                        <td>${u.full_name || '‚Äî'} ${u.student_class ? '('+u.student_class+')' : ''}</td>
                        <td>
                            <span class="badge" style="background:${getRoleColor(u.role)}; color:white;">
                                ${translateRole(u.role)}
                            </span>
                        </td>
                        <td>
                            <button class="btn dashboard" style="padding:5px 10px; font-size:12px; margin:0;" onclick='editUser(${JSON.stringify(u)})'>‚úèÔ∏è</button>
                            <button class="btn red" style="padding:5px 10px; font-size:12px; margin:0;" onclick="deleteUser(${u.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
            });
    }

    // 2. Form Logic (Add or Edit)
    document.getElementById('userForm').onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById('userId').value;
        const body = {
            username: document.getElementById('username').value,
            password: document.getElementById('password').value,
            role: document.getElementById('role').value,
            fullName: document.getElementById('fullName').value,
            studentClass: document.getElementById('studentClass').value
        };

        let res;
        if(id) {
            // Edit
            res = await fetch('/api/users/' + id, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)});
        } else {
            // Create (via existing register logic + fake code)
            body.secretCode = body.role === 'admin' ? 'ADMIN123' : 'TEACHER123'; 
            res = await fetch('/api/register', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)});
        }

        const data = await res.json();
        if(data.success || data.id) {
            alert('–£—Å–ø–µ—à–Ω–æ –∑–∞–ø–∞–∑–≤–∞–Ω–µ!');
            resetForm();
            loadUsers();
        } else {
            alert('–ì—Ä–µ—à–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'));
        }
    };

    function editUser(u) {
        document.getElementById('form-title').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ –Ω–∞: ' + u.username;
        document.getElementById('userId').value = u.id;
        document.getElementById('username').value = u.username;
        document.getElementById('password').value = ""; // Don't show old pass
        document.getElementById('role').value = u.role;
        document.getElementById('fullName').value = u.full_name || "";
        document.getElementById('studentClass').value = u.student_class || "";
        toggleFields();
        window.scrollTo({top:0, behavior:'smooth'});
    }

    function deleteUser(id) {
        if(confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ? –¢–æ–≤–∞ —â–µ –∏–∑—Ç—Ä–∏–µ –ø—Ä–æ—Ñ–∏–ª–∞ –∏ –≤—Å–∏—á–∫–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏.')) {
            fetch('/api/users/' + id, {method:'DELETE'}).then(() => loadUsers());
        }
    }

    function resetForm() {
        document.getElementById('userForm').reset();
        document.getElementById('userId').value = "";
        document.getElementById('form-title').textContent = "‚ûï –î–æ–±–∞–≤–∏ / –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π";
        toggleFields();
    }

    function toggleFields() {
        const role = document.getElementById('role').value;
        if(role === 'student') {
            document.getElementById('classField').style.display = 'block';
        } else {
            document.getElementById('classField').style.display = 'none';
        }
    }

    function getRoleColor(role) {
        if(role==='admin') return '#e74c3c';
        if(role==='teacher') return '#8e44ad';
        return '#2ecc71';
    }
    
    function translateRole(role) {
        if(role==='admin') return '–ê–¥–º–∏–Ω';
        if(role==='teacher') return '–£—á–∏—Ç–µ–ª';
        return '–£—á–µ–Ω–∏–∫';
    }

    // Init
    loadUsers();
    toggleFields();
    if (localStorage.getItem('dark') === 'true') document.body.classList.add('dark');
  </script>
</body>
</html>