<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8">
  <title>–°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ —Ç–µ—Å—Ç</title>
  <link rel="stylesheet" href="style.css">
  <script>
      const user = JSON.parse(localStorage.getItem('user'));
      if(!user || (user.role !== 'teacher' && user.role !== 'admin')) {
          alert('–ù—è–º–∞—Ç–µ –ø—Ä–∞–≤–∞!'); window.location.href = 'index.html';
      }
  </script>
  <style>
    .q-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .choice-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .points-row { display: flex; align-items: center; gap: 10px; font-weight: 600; margin: 15px 0; }
    .points-row input { width: 80px; text-align: center; }
    
    .img-upload-area {
        background: #f8fafc; border: 2px dashed #ccc; padding: 15px; text-align: center;
        border-radius: 8px; margin-bottom: 15px; cursor: pointer; transition: all 0.2s;
    }
    .img-upload-area:hover { border-color: var(--primary); background: #eef2ff; }
    .preview-thumb { max-height: 150px; margin-top: 10px; display: none; border-radius: 4px; border: 1px solid #ddd; }
  </style>
</head>
<body>
  <div class="container">
    <header style="text-align:center; margin-bottom:40px;">
        <h1>–°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ —Ç–µ—Å—Ç</h1>
    </header>
    
    <div style="max-width: 800px; margin: 0 auto;">
      <input type="text" id="title" placeholder="–ó–∞–≥–ª–∞–≤–∏–µ –Ω–∞ —Ç–µ—Å—Ç–∞ (–Ω–∞–ø—Ä. –ë–∏–æ–ª–æ–≥–∏—è 7 –∫–ª–∞—Å)" style="font-size: 1.2rem; font-weight: bold; margin-bottom: 40px;">

      <div id="questions"></div>

      <div style="text-align:center; margin: 50px 0;">
        <button onclick="addQuestion()" class="btn">+ –î–æ–±–∞–≤–∏ –≤—ä–ø—Ä–æ—Å</button>
        <button class="btn green" onclick="saveTest()">–ó–ê–ü–ê–ó–ò –¢–ï–°–¢–ê</button>
      </div>

      <a href="index.html" class="back-btn btn">–û–±—Ä–∞—Ç–Ω–æ</a>
    </div>
  </div>

  <script>
    let count = 0;

    function addQuestion() {
      count++;
      const div = document.createElement('div');
      div.className = 'qblock';
      div.innerHTML = `
        <div class="q-header">
            <span style="font-weight:bold; color:var(--primary); font-size:1.1em;">–í—ä–ø—Ä–æ—Å ${count}</span>
            <button type="button" class="btn red" onclick="this.closest('.qblock').remove()" style="padding: 6px 12px; font-size: 13px; margin:0;">–ò–∑—Ç—Ä–∏–π</button>
        </div>

        <select class="qtype" onchange="toggleType(this)">
          <option value="single">–ï–¥–Ω–æ–∫—Ä–∞—Ç–µ–Ω –∏–∑–±–æ—Ä</option>
          <option value="multiple">–ú–Ω–æ–≥–æ–∫—Ä–∞—Ç–µ–Ω –∏–∑–±–æ—Ä</option>
          <option value="open">–û—Ç–≤–æ—Ä–µ–Ω –≤—ä–ø—Ä–æ—Å</option>
        </select>

        <input type="text" placeholder="–ù–∞–ø–∏—à–µ—Ç–µ –≤—ä–ø—Ä–æ—Å–∞ —Ç—É–∫..." class="qtext">
        
        <div class="img-upload-area" onclick="document.getElementById('file${count}').click()">
            <span>üì∑ –î–æ–±–∞–≤–∏ —Å–Ω–∏–º–∫–∞</span>
            <input type="file" id="file${count}" accept="image/*" style="display:none" onchange="handleImage(this)">
            <input type="hidden" class="q-image-data">
            <br>
            <img class="preview-thumb">
        </div>

        <div class="points-row">
          <label>–¢–æ—á–∫–∏:</label>
          <input type="number" class="qpoints" min="1" max="20" value="1">
        </div>

        <div class="multi-count-options info-box" style="display:none; padding: 15px; margin: 15px 0;">
          <strong>–ò–∑–∏—Å–∫–≤–∞–Ω–µ –∑–∞ –≤–µ—Ä–Ω–∏ –æ—Ç–≥–æ–≤–æ—Ä–∏:</strong><br>
          <label style="margin-right:15px; cursor:pointer;"><input type="radio" name="multi-count${count}" value="2" checked onchange="limitCheckboxes(this)"> –¢–æ—á–Ω–æ 2 –≤–µ—Ä–Ω–∏</label>
          <label style="cursor:pointer;"><input type="radio" name="multi-count${count}" value="3" onchange="limitCheckboxes(this)"> –¢–æ—á–Ω–æ 3 –≤–µ—Ä–Ω–∏</label>
        </div>

        <div class="choice-options">
          ${[0,1,2,3].map(i => `
            <div class="choice-row">
              <input type="radio" name="correct${count}" value="${i}" class="single-correct" style="transform:scale(1.2)">
              <input type="checkbox" class="multi-correct" value="${i}" style="display:none; transform:scale(1.2)" onchange="enforceLimit(this)">
              <input type="text" placeholder="–û—Ç–≥–æ–≤–æ—Ä ${i+1}" class="opt">
            </div>
          `).join('')}
        </div>

        <div class="open-hint info-box" style="display:none; margin-top:15px;">
          ‚ÑπÔ∏è –£—á–µ–Ω–∏–∫—ä—Ç —â–µ –Ω–∞–ø–∏—à–µ —Å–≤–æ–±–æ–¥–µ–Ω —Ç–µ–∫—Å—Ç.
        </div>
      `;
      document.getElementById('questions').appendChild(div);
    }

    // === NEW: COMPRESS IMAGE FUNCTION ===
    function handleImage(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                
                img.onload = function() {
                    // Create canvas to resize
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800; // Resize to max 800px width
                    const MAX_HEIGHT = 800;
                    
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Compress to JPEG with 0.7 quality (makes files tiny but good quality)
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    
                    // Display and Store
                    const block = input.closest('.qblock');
                    const preview = block.querySelector('.preview-thumb');
                    const hidden = block.querySelector('.q-image-data');
                    
                    preview.src = dataUrl;
                    preview.style.display = 'inline-block';
                    hidden.value = dataUrl;
                }
            }
            reader.readAsDataURL(file);
        }
    }

    function toggleType(sel) {
      const block = sel.closest('.qblock');
      const multi = block.querySelector('.multi-count-options');
      const choices = block.querySelector('.choice-options');
      const hint = block.querySelector('.open-hint');
      const radios = block.querySelectorAll('.single-correct');
      const checks = block.querySelectorAll('.multi-correct');

      multi.style.display = choices.style.display = hint.style.display = 'none';
      radios.forEach(r => { r.style.display = 'none'; r.checked = false; });
      checks.forEach(c => { c.style.display = 'none'; c.checked = false; });

      if (sel.value === 'open') hint.style.display = 'block';
      else if (sel.value === 'single') {
        choices.style.display = 'block';
        radios.forEach(r => r.style.display = 'inline-block');
      } else {
        multi.style.display = 'block';
        choices.style.display = 'block';
        checks.forEach(c => c.style.display = 'inline-block');
        limitCheckboxes(block.querySelector('input[name^="multi-count"]:checked'));
      }
    }

    function enforceLimit(cb) {
      const block = cb.closest('.qblock');
      const max = +block.querySelector('input[name^="multi-count"]:checked').value;
      if ([...block.querySelectorAll('.multi-correct:checked')].length > max) {
        cb.checked = false; alert(`–ú–∞–∫—Å–∏–º—É–º ${max} –≤–µ—Ä–Ω–∏ –æ—Ç–≥–æ–≤–æ—Ä–∞!`);
      }
    }

    function limitCheckboxes(radio) {
      const block = radio.closest('.qblock');
      const max = +radio.value;
      const checked = block.querySelectorAll('.multi-correct:checked');
      if (checked.length > max) {
        for (let i = max; i < checked.length; i++) checked[i].checked = false;
      }
    }

    async function saveTest() {
      const title = document.getElementById('title').value.trim();
      if (!title) return alert('–í—ä–≤–µ–¥–µ—Ç–µ –∑–∞–≥–ª–∞–≤–∏–µ!');

      const questions = [];
      let error = false;

      document.querySelectorAll('.qblock').forEach(b => {
        if (error) return;
        const text = b.querySelector('.qtext').value.trim();
        const type = b.querySelector('.qtype').value;
        const points = Math.max(1, +b.querySelector('.qpoints').value || 1);
        const imageData = b.querySelector('.q-image-data').value;
        
        if (!text) return;

        let qObj = { text, type, points, image: imageData }; 

        if (type === 'open') { 
            questions.push(qObj); 
            return; 
        }

        const opts = [...b.querySelectorAll('.opt')].map(o => o.value.trim()).filter(Boolean);
        if (opts.length < 2) { error = true; alert('–í—Å–µ–∫–∏ –≤—ä–ø—Ä–æ—Å —Ç—Ä—è–±–≤–∞ –¥–∞ –∏–º–∞ –ø–æ–Ω–µ 2 –æ—Ç–≥–æ–≤–æ—Ä–∞!'); return; }
        
        qObj.options = opts;

        if (type === 'single') {
          const sel = b.querySelector('input.single-correct:checked');
          if (!sel) { error = true; alert('–ü–æ—Å–æ—á–µ—Ç–µ –≤–µ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä!'); return; }
          qObj.correct = +sel.value;
        } else {
          const req = +b.querySelector('input[name^="multi-count"]:checked').value;
          const checked = b.querySelectorAll('.multi-correct:checked');
          if (checked.length !== req) { error = true; alert(`–ó–∞ "${text}" –ø–æ—Å–æ—á–µ—Ç–µ —Ç–æ—á–Ω–æ ${req} –≤–µ—Ä–Ω–∏!`); return; }
          qObj.correct = [...checked].map(c => +c.value);
          qObj.requiredCount = req;
        }
        questions.push(qObj);
      });

      if (error || !questions.length) { if(!questions.length) alert("–î–æ–±–∞–≤–µ—Ç–µ –ø–æ–Ω–µ –µ–¥–∏–Ω –≤—ä–ø—Ä–æ—Å."); return; }

      // Better error handling
      try {
          const res = await fetch('/api/tests', { 
              method: 'POST', 
              headers: {'Content-Type':'application/json'}, 
              body: JSON.stringify({title, questions, creatorId: user.id}) 
          });
          
          const data = await res.json();
          if (res.ok) { alert('–ó–∞–ø–∞–∑–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!'); location.href='index.html'; }
          else { alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∞–∑–≤–∞–Ω–µ: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞ –≥—Ä–µ—à–∫–∞')); }
      } catch (err) {
          alert('–ú—Ä–µ–∂–æ–≤–∞ –≥—Ä–µ—à–∫–∞! –°–Ω–∏–º–∫–∏—Ç–µ –º–æ–∂–µ –¥–∞ —Å–∞ —Ç–≤—ä—Ä–¥–µ –≥–æ–ª–µ–º–∏ –≤—ä–ø—Ä–µ–∫–∏ –∫–æ–º–ø—Ä–µ—Å–∏—è—Ç–∞.');
      }
    }

    addQuestion();
    if (localStorage.getItem('dark') === 'true') document.body.classList.add('dark');
  </script>
</body>
</html>