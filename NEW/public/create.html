<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8">
  <title>Създаване на тест</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .q-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .choice-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .choice-row input[type="text"] { margin: 0; }
    .points-row { display: flex; align-items: center; gap: 10px; font-weight: 600; margin: 15px 0; }
    .points-row input { width: 80px; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <header style="text-align:center; margin-bottom:40px;">
        <h1>Създаване на тест</h1>
    </header>
    
    <div style="max-width: 800px; margin: 0 auto;">
      <input type="text" id="title" placeholder="Заглавие на теста (напр. Математика 5 клас)" style="font-size: 1.2rem; font-weight: bold; margin-bottom: 40px;">

      <div id="questions"></div>

      <div style="text-align:center; margin: 50px 0;">
        <button onclick="addQuestion()" class="btn">+ Добави въпрос</button>
        <button class="btn green" onclick="saveTest()">ЗАПАЗИ ТЕСТА</button>
      </div>

      <a href="index.html" class="back-btn btn">Обратно</a>
    </div>
  </div>

  <script>
    let count = 0;

    function addQuestion() {
      count++;
      const div = document.createElement('div');
      div.className = 'qblock';
      div.innerHTML = `
        <div class="q-header">
            <span style="font-weight:bold; color:var(--primary); font-size:1.1em;">Въпрос ${count}</span>
            <button type="button" class="btn red" onclick="this.closest('.qblock').remove()" style="padding: 6px 12px; font-size: 13px; margin:0;">Изтрий</button>
        </div>

        <select class="qtype" onchange="toggleType(this)">
          <option value="single">Еднократен избор</option>
          <option value="multiple">Многократен избор</option>
          <option value="open">Отворен въпрос</option>
        </select>

        <input type="text" placeholder="Напишете въпроса тук..." class="qtext">

        <div class="points-row">
          <label>Точки:</label>
          <input type="number" class="qpoints" min="1" max="20" value="1">
        </div>

        <div class="multi-count-options info-box" style="display:none; padding: 15px; margin: 15px 0;">
          <strong>Изискване за верни отговори:</strong><br>
          <label style="margin-right:15px; cursor:pointer;"><input type="radio" name="multi-count${count}" value="2" checked onchange="limitCheckboxes(this)"> Точно 2 верни</label>
          <label style="cursor:pointer;"><input type="radio" name="multi-count${count}" value="3" onchange="limitCheckboxes(this)"> Точно 3 верни</label>
        </div>

        <div class="choice-options">
          ${[0,1,2,3].map(i => `
            <div class="choice-row">
              <input type="radio" name="correct${count}" value="${i}" class="single-correct" style="transform:scale(1.2)">
              <input type="checkbox" class="multi-correct" value="${i}" style="display:none; transform:scale(1.2)" onchange="enforceLimit(this)">
              <input type="text" placeholder="Отговор ${i+1}" class="opt">
            </div>
          `).join('')}
        </div>

        <div class="open-hint info-box" style="display:none; margin-top:15px;">
          ℹ️ Ученикът ще напише свободен текст. Този въпрос изисква ръчна проверка от учителя.
        </div>
      `;
      document.getElementById('questions').appendChild(div);
    }

    function toggleType(sel) {
      const block = sel.closest('.qblock');
      const multi = block.querySelector('.multi-count-options');
      const choices = block.querySelector('.choice-options');
      const hint = block.querySelector('.open-hint');
      const radios = block.querySelectorAll('.single-correct');
      const checks = block.querySelectorAll('.multi-correct');

      multi.style.display = choices.style.display = hint.style.display = 'none';
      radios.forEach(r => { r.style.display = 'none'; r.checked = false; });
      checks.forEach(c => { c.style.display = 'none'; c.checked = false; });

      if (sel.value === 'open') hint.style.display = 'block';
      else if (sel.value === 'single') {
        choices.style.display = 'block';
        radios.forEach(r => r.style.display = 'inline-block');
      } else {
        multi.style.display = 'block';
        choices.style.display = 'block';
        checks.forEach(c => c.style.display = 'inline-block');
        limitCheckboxes(block.querySelector('input[name^="multi-count"]:checked'));
      }
    }

    function enforceLimit(cb) {
      const block = cb.closest('.qblock');
      const max = +block.querySelector('input[name^="multi-count"]:checked').value;
      if ([...block.querySelectorAll('.multi-correct:checked')].length > max) {
        cb.checked = false;
        alert(`Максимум ${max} верни отговора!`);
      }
    }

    function limitCheckboxes(radio) {
      const block = radio.closest('.qblock');
      const max = +radio.value;
      const checked = block.querySelectorAll('.multi-correct:checked');
      if (checked.length > max) {
        for (let i = max; i < checked.length; i++) checked[i].checked = false;
      }
    }

    async function saveTest() {
      const title = document.getElementById('title').value.trim();
      if (!title) return alert('Моля, въведете заглавие на теста!');

      const questions = [];
      let error = false;

      document.querySelectorAll('.qblock').forEach(b => {
        if (error) return;
        const text = b.querySelector('.qtext').value.trim();
        const type = b.querySelector('.qtype').value;
        const points = Math.max(1, +b.querySelector('.qpoints').value || 1);
        if (!text) return;

        if (type === 'open') { questions.push({ text, type: 'open', points }); return; }

        const opts = [...b.querySelectorAll('.opt')].map(o => o.value.trim()).filter(Boolean);
        if (opts.length < 2) { error = true; alert('Всеки въпрос трябва да има поне 2 отговора!'); return; }

        if (type === 'single') {
          const sel = b.querySelector('input.single-correct:checked');
          if (!sel) { error = true; alert('Моля посочете верния отговор за всички въпроси!'); return; }
          questions.push({ text, type: 'single', options: opts, correct: +sel.value, points });
        } else {
          const req = +b.querySelector('input[name^="multi-count"]:checked').value;
          const checked = b.querySelectorAll('.multi-correct:checked');
          if (checked.length !== req) { error = true; alert(`За въпросите с многократен избор трябва да посочите точно ${req} верни!`); return; }
          questions.push({ text, type: 'multiple', options: opts, correct: [...checked].map(c => +c.value), requiredCount: req, points });
        }
      });

      if (error || !questions.length) {
          if(!questions.length) alert("Моля добавете поне един въпрос.");
          return;
      }

      const res = await fetch('/api/tests', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({title, questions}) });
      if (res.ok) { alert('Тестът е запазен успешно!'); location.href='index.html'; }
      else alert('Възникна грешка при запазване.');
    }

    addQuestion();

    if (localStorage.getItem('dark') === 'true') document.body.classList.add('dark');
  </script>
</body>
</html>