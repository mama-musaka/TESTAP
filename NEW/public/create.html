<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8">
  <title>Създаване на тест</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Page specific tweaks */
    body { background: linear-gradient(135deg,#667eea,#764ba2); }
    body.dark { background: #0d1117; }

    .main { padding:40px 45px; }
    header { 
        background: linear-gradient(135deg, #4361ee, #5d7bff); 
        color: white; 
        padding: 30px; 
        text-align: center; 
        font-size: 34px; 
        font-weight: 900;
        border-radius: 15px 15px 0 0; /* Rounded top corners */
    }

    /* Specific internal styles */
    .points-row { display:flex; align-items:center; margin:10px 0; font-weight:bold; }
    .points-row input[type="number"] { width:90px; text-align:center; margin-left: 10px; }
    
    .multi-count-options {
      background:#fff8e1; padding:14px; border-radius:9px; border-left:5px solid #f39c12; margin:12px 0;
    }
    .open-hint {
      background:#f0f8ff; padding:12px; border-radius:9px; border-left:5px solid #3498db;
      font-style:italic; margin:12px 0;
    }
    .choice-options > div { display:flex; align-items:center; margin:8px 0; }
    .choice-options input[type="text"] { flex:1; margin-left:8px; }
    
    .back-btn {
      display:block; width:fit-content; margin:50px auto 0; padding:15px 60px;
      background:#4361ee; color:white; font-size:20px; font-weight:bold;
      border-radius:50px; text-decoration:none; text-align:center;
    }
    .back-btn:hover { filter: brightness(110%); transform:translateY(-2px); }
    hr { border:0.8px dashed #ccc; margin:25px 0; }
  </style>
</head>
<body>
  <div class="container" style="padding:0;">
    <header>СЪЗДАВАНЕ НА ТЕСТ</header>
    <div class="main">
      <input type="text" id="title" placeholder="Заглавие на теста" style="font-size: 20px; font-weight: bold;">

      <div id="questions"></div>

      <div style="text-align:center; margin:35px 0;">
        <button onclick="addQuestion()">+ Добави въпрос</button>
        <button class="green" onclick="saveTest()" style="font-size:18px; padding:12px 40px;">
          ЗАПАЗИ ТЕСТА
        </button>
      </div>

      <a href="index.html" class="back-btn">Обратно</a>
    </div>
  </div>

  <script>
    let count = 0;

    function addQuestion() {
      count++;
      const div = document.createElement('div');
      div.className = 'qblock';
      div.innerHTML = `
        <select class="qtype" onchange="toggleType(this)">
          <option value="single">Еднократен избор</option>
          <option value="multiple">Многократен избор (2 или 3)</option>
          <option value="open">Отворен въпрос</option>
        </select>

        <input type="text" placeholder="Текст на въпроса" class="qtext">

        <div class="points-row">
          <label>Точки:</label>
          <input type="number" class="qpoints" min="1" max="10" value="10">
        </div>

        <div class="multi-count-options" style="display:none;">
          <strong>Верни отговори:</strong><br>
          <label><input type="radio" name="multi-count${count}" value="2" checked onchange="limitCheckboxes(this)"> Точно 2</label>    
          <label><input type="radio" name="multi-count${count}" value="3" onchange="limitCheckboxes(this)"> Точно 3</label>
        </div>

        <div class="choice-options">
          ${[0,1,2,3].map(i => `
            <div>
              <input type="radio" name="correct${count}" value="${i}" class="single-correct">
              <input type="checkbox" class="multi-correct" value="${i}" style="display:none" onchange="enforceLimit(this)">
              <input type="text" placeholder="Отговор ${i+1}" class="opt">
            </div>
          `).join('')}
        </div>

        <div class="open-hint" style="display:none;">
          Ученикът пише свободен текст – ръчна проверка.
        </div>

        <div style="text-align:right;">
          <button type="button" class="red" onclick="this.closest('.qblock').remove()" style="padding: 8px 16px; font-size: 14px;">
            Изтрий
          </button>
        </div>
        <hr>
      `;
      document.getElementById('questions').appendChild(div);
    }

    function toggleType(sel) {
      const block = sel.closest('.qblock');
      const multi = block.querySelector('.multi-count-options');
      const choices = block.querySelector('.choice-options');
      const hint = block.querySelector('.open-hint');
      const radios = block.querySelectorAll('.single-correct');
      const checks = block.querySelectorAll('.multi-correct');

      multi.style.display = choices.style.display = hint.style.display = 'none';
      radios.forEach(r => { r.style.display = 'none'; r.checked = false; });
      checks.forEach(c => { c.style.display = 'none'; c.checked = false; });

      if (sel.value === 'open') hint.style.display = 'block';
      else if (sel.value === 'single') {
        choices.style.display = 'block';
        radios.forEach(r => r.style.display = 'inline');
      } else {
        multi.style.display = choices.style.display = 'block';
        checks.forEach(c => c.style.display = 'inline');
        limitCheckboxes(block.querySelector('input[name^="multi-count"]:checked'));
      }
    }

    function enforceLimit(cb) {
      const block = cb.closest('.qblock');
      const max = +block.querySelector('input[name^="multi-count"]:checked').value;
      if ([...block.querySelectorAll('.multi-correct:checked')].length > max) {
        cb.checked = false;
        alert(`Макс ${max} верни!`);
      }
    }

    function limitCheckboxes(radio) {
      const block = radio.closest('.qblock');
      const max = +radio.value;
      const checked = block.querySelectorAll('.multi-correct:checked');
      if (checked.length > max) {
        for (let i = max; i < checked.length; i++) checked[i].checked = false;
      }
    }

    async function saveTest() {
      const title = document.getElementById('title').value.trim();
      if (!title) return alert('Въведи заглавие!');

      const questions = [];
      let error = false;

      document.querySelectorAll('.qblock').forEach(b => {
        if (error) return;
        const text = b.querySelector('.qtext').value.trim();
        const type = b.querySelector('.qtype').value;
        const points = Math.max(1, Math.min(10, +b.querySelector('.qpoints').value || 10));
        if (!text) return;

        if (type === 'open') { questions.push({ text, type: 'open', points }); return; }

        const opts = [...b.querySelectorAll('.opt')].map(o => o.value.trim()).filter(Boolean);
        if (opts.length < 2) { error = true; alert('Минимум 2 отговора!'); return; }

        if (type === 'single') {
          const sel = b.querySelector('input.single-correct:checked');
          if (!sel) { error = true; alert('Избери верен!'); return; }
          questions.push({ text, type: 'single', options: opts, correct: +sel.value, points });
        } else {
          const req = +b.querySelector('input[name^="multi-count"]:checked').value;
          const checked = b.querySelectorAll('.multi-correct:checked');
          if (checked.length !== req) { error = true; alert(`Трябва точно ${req} верни!`); return; }
          questions.push({ text, type: 'multiple', options: opts, correct: [...checked].map(c => +c.value), requiredCount: req, points });
        }
      });

      if (error || !questions.length) return;

      const res = await fetch('/api/tests', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({title, questions}) });
      if (res.ok) { alert('Запазено!'); location.href='index.html'; }
      else alert('Грешка');
    }

    addQuestion();

    // Global Dark Mode Toggle
    if (localStorage.getItem('dark') === 'true') document.body.classList.add('dark');
    document.addEventListener('DOMContentLoaded', () => {
      let btn = document.getElementById('global-dark-toggle');
      if (!btn) {
        btn = document.createElement('button');
        btn.id = 'global-dark-toggle';
        btn.textContent = document.body.classList.contains('dark') ? '☀' : '☾';
        btn.style.cssText = 'position:fixed; top:15px; right:15px; z-index:99999; background:rgba(0,0,0,0.6); color:white; border:none; padding:8px 15px; border-radius:50px; font-size:18px; cursor:pointer; backdrop-filter:blur(5px); margin:0;';
        document.body.appendChild(btn);
        btn.onclick = () => {
          document.body.classList.toggle('dark');
          localStorage.setItem('dark', document.body.classList.contains('dark'));
          btn.textContent = document.body.classList.contains('dark') ? '☀' : '☾';
        };
      }
    });
  </script>
</body>
</html>