<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8">
  <title>Преглед на отговор</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { margin:0; background:#f4f6f9; font-family:'Segoe UI',sans-serif; padding:30px; }
    .card { max-width:900px; margin:0 auto; background:white; border-radius:15px; padding:30px; box-shadow:0 15px 40px rgba(0,0,0,0.1); }
    h1 { color:#2c3e50; text-align:center; margin-bottom:10px; }
    .info { background:#f0f4ff; padding:15px; border-radius:10px; margin-bottom:20px; }
    .question { background:#fafbff; padding:20px; margin:20px 0; border-radius:12px; border-left:5px solid #4361ee; }
    .open-answer textarea { width:100%; min-height:120px; padding:15px; border:2px solid #ddd; border-radius:10px; margin-bottom:15px; }
    .points-select { padding:10px; font-size:18px; border-radius:8px; border:2px solid #4361ee; background:white; }
    .save-points { background:#06d6a0; color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; margin-left:10px; font-weight:bold; }
    .back-btn { display:block; width:fit-content; margin:40px auto 0; padding:18px 70px; background:#4361ee; color:white; font-size:22px; border-radius:50px; text-decoration:none; box-shadow:0 12px 35px rgba(67,97,238,0.4); text-align:center; }
    .back-btn:hover { background:#3550d4; transform:translateY(-3px); }
  </style>
  
</head>

<body>
  <div class="card">
    <h1 id="title">Зареждане...</h1>
    <div class="info" id="info"></div>
    <div id="answers"></div>
    <div style="text-align:center;">
      <a href="dashboard.html" class="back-btn">Обратно към дашборда</a>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const submissionId = params.get('id');

    fetch(`/api/submission/${submissionId}`)
      .then(r => r.json())
      .then(data => {
        document.getElementById('title').textContent = `${data.studentName} – ${data.testTitle}`;
        document.getElementById('info').innerHTML = `
          <strong>Клас:</strong> ${data.studentClass || '—'}<br>
          <strong>Предаден на:</strong> ${new Date(data.submittedAt).toLocaleString('bg-BG')}<br>
          <strong>Автоматична оценка:</strong> ${data.autoGrade || '—'}
        `;

        let savedPoints = {};
        try { savedPoints = JSON.parse(data.manualPoints || '{}'); } catch(e) {}

        const html = data.answers.map((a, i) => {
          const q = data.questions[i] || {};
          const maxPoints = q.points || 10;

          if (a.type === 'open') {
            const current = savedPoints[i] !== undefined ? savedPoints[i] : maxPoints;
            return `
              <div class="question">
                <h3>Въпрос ${i+1}: ${a.question} <small style="color:#666">(до ${maxPoints} т.)</small></h3>
                <div class="open-answer">
                  <p><strong>Отговор на ученика:</strong></p>
                  <textarea readonly>${a.studentAnswer || ''}</textarea>
                  <p style="margin-top:15px; font-weight:bold;">
                    Дай точки (1–${maxPoints}):
                    <select class="points-select" data-index="${i}">
                      ${Array.from({length: maxPoints}, (_, p) => p + 1)
                        .map(p => `<option value="${p}" ${p===current?'selected':''}>${p}</option>`).join('')}
                    </select>
                    <button class="save-points" onclick="saveOpenPoints(${submissionId},${i},this.previousElementSibling.value)">
                      Запази
                    </button>
                  </p>
                </div>
              </div>
            `;
          }

          const correct = Array.isArray(a.correctAnswer) ? a.correctAnswer.map(n => q.options?.[n] || n).join(', ') : q.options?.[a.correctAnswer] || '';
          const student = Array.isArray(a.studentAnswer) ? a.studentAnswer.map(n => q.options?.[n] || n).join(', ') : '—';
          const color = a.isCorrect ? '#06d6a0' : '#ef476f';
          return `
            <div class="question">
              <h3>Въпрос ${i+1}: ${a.question} <small style="color:#666">(${maxPoints} т.)</small></h3>
              <p><strong>Верен:</strong> <span style="color:green">${correct}</span></p>
              <p><strong>Ученик:</strong> <span style="color:${color}">${student}</span></p>
            </div>
          `;
        }).join('');
        document.getElementById('answers').innerHTML = html;
      });

    async function saveOpenPoints(submissionId, questionIndex, points) {
      const res = await fetch('/api/submission-points/' + submissionId, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ questionIndex: parseInt(questionIndex), points: parseInt(points) })
      });
      if ((await res.json()).success) {
        alert('Точките са запазени успешно!');
      } else {
        alert('Грешка при запазване');
      }
    }
  </script>
  <!-- ГЛОБАЛЕН DARK MODE – сложи този код на ВСЯКА страница преди </body> -->
<script>
// Прилагаме текущото състояние
if (localStorage.getItem('dark') === 'true') {
  document.body.classList.add('dark');
}

// Създаваме бутончето (ако го няма)
document.addEventListener('DOMContentLoaded', () => {
  let btn = document.getElementById('global-dark-toggle');
  if (!btn) {
    btn = document.createElement('button');
    btn.id = 'global-dark-toggle';
    btn.textContent = document.body.classList.contains('dark') ? 'Light Mode' : 'Dark Mode';
    btn.style.cssText = `
      position:fixed; top:15px; right:15px; z-index:99999;
      background:rgba(0,0,0,0.7); color:white; border:none; padding:10px 18px;
      border-radius:50px; font-size:14px; font-weight:bold; cursor:pointer;
      box-shadow:0 4px 20px rgba(0,0,0,0.5); backdrop-filter:blur(10px);
    `;
    document.body.appendChild(btn);

    btn.onclick = () => {
      document.body.classList.toggle('dark');
      const isDark = document.body.classList.contains('dark');
      localStorage.setItem('dark', isDark);
      btn.textContent = isDark ? 'Light Mode' : 'Dark Mode';
    };
  }
});
</script>

<style>
/* ТЪМНА ТЕМА – работи за всички твои страници */
body.dark { background:#0d1117 !important; color:#c9d1d9 !important; }
body.dark .container,
body.dark .main,
body.dark .qblock,
body.dark .test-card { background:#161b22 !important; }
body.dark input,
body.dark select,
body.dark textarea { background:#0d1117 !important; color:#c9d1d9 !important; border-color:#30363d !important; }
body.dark hr { border-color:#30363d !important; }
body.dark .open-hint { background:#0d1117 !important; border-left-color:#58a6ff !important; color:#8b949e !important; }
body.dark .multi-count-options { background:#2d1a00 !important; color:#fff !important; }
body.dark table { background:#161b22 !important; }
body.dark th { background:#1f6feb !important; }
</style>
</body>
</html>