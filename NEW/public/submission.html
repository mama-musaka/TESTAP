<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8">
  <title>Преглед на отговор</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { margin:0; background:#f4f6f9; font-family:'Segoe UI',sans-serif; padding:30px; }
    .card { max-width:900px; margin:0 auto; background:white; border-radius:15px; padding:30px; box-shadow:0 15px 40px rgba(0,0,0,0.1); }
    h1 { color:#2c3e50; text-align:center; }
    .info { background:#f0f4ff; padding:15px; border-radius:10px; margin-bottom:20px; }
    .question { background:#fafbff; padding:20px; margin:20px 0; border-radius:12px; border-left:5px solid #4361ee; }
    .open-answer textarea { width:100%; min-height:120px; padding:15px; border:2px solid #ddd; border-radius:10px; }
    .grade-input { width:80px; padding:10px; font-size:18px; text-align:center; border-radius:8px; border:2px solid #ddd; }
    .save-btn { background:#06d6a0; color:white; padding:12px 30px; border:none; border-radius:50px; cursor:pointer; font-size:18px; margin-top:20px; }
  </style>
</head>
<body>
  <div class="card">
    <h1 id="title">Зареждане...</h1>
    <div class="info" id="info"></div>
    <div id="answers"></div>
    <button class="save-btn" onclick="saveGrades()">Запази оценките</button>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const submissionId = params.get('id');
    const testId = params.get('test');

    fetch(`/api/submission/${submissionId}`)
      .then(r => r.json())
      .then(data => {
        document.getElementById('title').textContent = `${data.studentName} – ${data.testTitle}`;
        document.getElementById('info').innerHTML = `
          <strong>Клас:</strong> ${data.studentClass || '—'}<br>
          <strong>Предаден на:</strong> ${new Date(data.submittedAt).toLocaleString('bg-BG')}<br>
          <strong>Автоматична оценка:</strong> ${data.autoGrade || '—'}
        `;

        const html = data.answers.map((a, i) => {
          if (a.type === 'open') {
            return `
              <div class="question">
                <h3>Въпрос ${i+1}: ${a.question}</h3>
                <div class="open-answer">
                  <p><strong>Отговор на ученика:</strong></p>
                  <textarea readonly>${a.studentAnswer || ''}</textarea>
                  <p style="margin-top:15px;">
                    <label>Точки (0-10): <input type="number" min="0" max="10" value="${a.manualPoints || 0}" class="grade-input" data-index="${i}"></label>
                  </p>
                </div>
              </div>
            `;
          }
          const correct = Array.isArray(a.correctAnswer) ? a.correctAnswer.join(', ') : a.correctAnswer;
          const student = Array.isArray(a.studentAnswer) ? a.studentAnswer.join(', ') : (a.studentAnswer || '—');
          const status = a.isCorrect ? 'Верен' : 'Грешен';
          const color = a.isCorrect ? '#06d6a0' : '#ef476f';
          return `
            <div class="question">
              <h3>Въпрос ${i+1}: ${a.question}</h3>
              <p><strong>Верен отговор:</strong> <span style="color:green">${correct}</span></p>
              <p><strong>Отговор на ученика:</strong> <span style="color:${color}">${student}</span> → ${status}</p>
            </div>
          `;
        }).join('');

        document.getElementById('answers').innerHTML = html;
      });

    function saveGrades() {
      const grades = [];
      document.querySelectorAll('.grade-input').forEach(input => {
        grades.push({
          questionIndex: parseInt(input.dataset.index),
          points: parseInt(input.value) || 0
        });
      });

      fetch(`/api/grade-open/${submissionId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ grades })
      }).then(() => {
        alert('Оценките са запазени успешно!');
        location.reload();
      });
    }
  </script>
</body>
</html>