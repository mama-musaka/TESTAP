<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8">
  <title>–ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .review-panel {
        background: #fdfdfd; border: 2px solid #e0e0e0; border-radius: 12px;
        padding: 30px; margin-top: 40px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    .review-header {
        font-size: 1.3rem; font-weight: 700; color: var(--text-main);
        margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee;
    }
    textarea.comment-box {
        width: 100%; min-height: 120px; padding: 15px; border: 1px solid #ccc;
        border-radius: 8px; font-family: inherit; font-size: 1rem; resize: vertical; margin-bottom: 20px; box-sizing: border-box;
    }
    .final-grade-row { display: flex; align-items: center; justify-content: flex-end; gap: 15px; }
    .grade-select { font-weight: bold; transition: all 0.3s; border: 2px solid transparent; outline:none; }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="title" style="margin-bottom:20px;">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</h1>
    
    <div class="info-box" id="info"></div>
    <div id="answers"></div>
    
    <div class="review-panel">
        <div class="review-header">üìù –û—Ü–µ–Ω–∫–∞ –∏ –ö–æ–º–µ–Ω—Ç–∞—Ä –æ—Ç —É—á–∏—Ç–µ–ª—è</div>
        <label style="font-weight:bold; display:block; margin-bottom:8px;">–ö–æ–º–µ–Ω—Ç–∞—Ä:</label>
        <textarea id="teacherComment" class="comment-box" placeholder="–ù–∞–ø–∏—à–µ—Ç–µ –∫–æ–º–µ–Ω—Ç–∞—Ä –∏–ª–∏ –ø—Ä–µ–ø–æ—Ä—ä–∫–∞ –∫—ä–º —É—á–µ–Ω–∏–∫–∞..."></textarea>
        
        <div class="final-grade-row">
            <label style="font-weight:bold; font-size:1.1rem;">–ö—Ä–∞–π–Ω–∞ –û—Ü–µ–Ω–∫–∞:</label>
            <select id="finalGrade" class="grade-select" style="font-size:1.1rem; padding:8px 15px;" onchange="updateGradeColor(this)">
                <option value="‚Äî">‚Äî</option>
                <option value="2">2.00 (–°–ª–∞–±)</option>
                <option value="3">3.00 (–°—Ä–µ–¥–µ–Ω)</option>
                <option value="4">4.00 (–î–æ–±—ä—Ä)</option>
                <option value="5">5.00 (–ú–Ω. –î–æ–±—ä—Ä)</option>
                <option value="6">6.00 (–û—Ç–ª–∏—á–µ–Ω)</option>
            </select>
            <button class="btn btn-primary" onclick="saveFinalReview()">üíæ –ó–ê–ü–ê–ó–ò –û–¶–ï–ù–ö–ê–¢–ê</button>
        </div>
    </div>

    <div style="text-align:center; margin-top:40px;">
      <a href="javascript:history.back()" class="back-btn btn">–û–±—Ä–∞—Ç–Ω–æ</a>
    </div>
  </div>

  <div id="lightbox" class="lightbox" onclick="closeLightbox()">
      <span class="lightbox-close">&times;</span>
      <img id="lightbox-img" src="">
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const submissionId = params.get('id');

    fetch(`/api/submission/${submissionId}`)
      .then(r => r.json())
      .then(data => {
        document.getElementById('title').textContent = `${data.studentName} ‚Äì ${data.testTitle}`;
        const ag = parseFloat(data.autoGrade || 0);
        let agColor = '#333';
        if(ag >= 5.50) agColor = '#06d6a0'; 
        else if(ag >= 4.50) agColor = '#3498db'; 
        else if(ag >= 3.50) agColor = '#f1c40f'; // Yellow
        else if(ag >= 3.00) agColor = '#fd7e14'; // Orange
        else agColor = '#ef476f'; 

        document.getElementById('info').innerHTML = `
          <strong>–ö–ª–∞—Å:</strong> ${data.studentClass || '‚Äî'}<br>
          <strong>–ü—Ä–µ–¥–∞–¥–µ–Ω –Ω–∞:</strong> ${new Date(data.submittedAt).toLocaleString('bg-BG')}<br>
          <strong>–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –æ—Ü–µ–Ω–∫–∞:</strong> <span style="color:${agColor}; font-weight:bold; font-size:1.2em; text-shadow: 0 0 10px ${agColor}40;">${data.autoGrade || '‚Äî'}</span>
        `;

        if(data.teacherComment) document.getElementById('teacherComment').value = data.teacherComment;
        
        const currentGrade = (data.manualGrade && data.manualGrade !== '‚Äî') ? Math.round(data.manualGrade) : Math.round(data.autoGrade);
        const sel = document.getElementById('finalGrade');
        if(currentGrade >= 2 && currentGrade <= 6) sel.value = currentGrade;
        updateGradeColor(sel);

        let savedPoints = {};
        try { savedPoints = JSON.parse(data.manualPoints || '{}'); } catch(e) {}

        const html = data.answers.map((a, i) => {
          const q = data.questions[i] || {};
          const maxPoints = q.points || 1;
          
          let imgHTML = '';
          if(q.image) {
              imgHTML = `<div class="q-image-container"><img src="${q.image}" class="q-image" onclick="openLightbox(this.src)" style="max-height:150px;"></div>`;
          }

          if (a.type === 'open') {
            const current = savedPoints[i] !== undefined ? savedPoints[i] : 0;
            return `
              <div class="qblock answer-block" style="border-left: 5px solid #7209b7;">
                <h3>${i+1}. ${a.question} <small style="opacity:0.6; font-size:0.7em;">(–º–∞–∫—Å ${maxPoints} —Ç.)</small></h3>
                ${imgHTML}
                <p><strong>–û—Ç–≥–æ–≤–æ—Ä –Ω–∞ —É—á–µ–Ω–∏–∫–∞:</strong></p>
                <div class="student-answer-box">${a.studentAnswer || '(–Ω—è–º–∞ –æ—Ç–≥–æ–≤–æ—Ä)'}</div>
                <div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee; display:flex; align-items:center; justify-content:flex-end;">
                  <span style="margin-right:10px; font-size:0.9em;">–¢–æ—á–∫–∏:</span>
                  <select class="points-select" style="width:auto; margin:0 10px 0 0;" data-index="${i}">
                    ${Array.from({length: maxPoints + 1}, (_, p) => p).map(p => `<option value="${p}" ${p==current?'selected':''}>${p}</option>`).join('')}
                  </select>
                  <button class="btn green" style="margin:0; padding:6px 12px; font-size:12px;" onclick="saveOpenPoints(${submissionId},${i},this.previousElementSibling.value)">–û–ö</button>
                </div>
              </div>`;
          }

          const correct = Array.isArray(a.correctAnswer) ? a.correctAnswer.map(n => q.options?.[n] || n).join(', ') : q.options?.[a.correctAnswer] || '';
          const student = Array.isArray(a.studentAnswer) ? a.studentAnswer.map(n => q.options?.[n] || n).join(', ') : '‚Äî';
          const color = a.isCorrect ? '#06d6a0' : '#ef476f';
          
          return `
            <div class="qblock" style="border-left: 5px solid ${color};">
                <h3>${i+1}. ${a.question}</h3>
                ${imgHTML}
                <p style="margin:5px 0;"><strong>–í–µ—Ä–µ–Ω:</strong> <span style="color:#2ecc71;">${correct}</span></p>
                <p style="margin:5px 0;"><strong>–£—á–µ–Ω–∏–∫:</strong> <span style="color:${color}; font-weight:bold;">${student}</span></p>
            </div>`;
        }).join('');
        
        document.getElementById('answers').innerHTML = html;
      });

    function openLightbox(src) {
        document.getElementById('lightbox-img').src = src;
        document.getElementById('lightbox').style.display = 'flex';
    }
    function closeLightbox() {
        document.getElementById('lightbox').style.display = 'none';
    }

    function updateGradeColor(select) {
        const val = parseFloat(select.value);
        let color = '#333'; let bg = '#fff'; let shadow = 'none';
        
        if (val >= 5.50) { color = '#06d6a0'; bg = 'rgba(6, 214, 160, 0.15)'; shadow='0 0 10px rgba(6,214,160,0.3)'; }
        else if (val >= 4.50) { color = '#3498db'; bg = 'rgba(52, 152, 219, 0.15)'; shadow='0 0 10px rgba(52,152,219,0.3)'; }
        else if (val >= 3.50) { color = '#f1c40f'; bg = 'rgba(241, 196, 15, 0.15)'; shadow='0 0 10px rgba(241,196,15,0.3)'; }
        else if (val >= 3.00) { color = '#fd7e14'; bg = 'rgba(253, 126, 20, 0.15)'; shadow='0 0 10px rgba(253,126,20,0.3)'; }
        else if (val >= 2.00) { color = '#ef476f'; bg = 'rgba(239, 71, 111, 0.15)'; shadow='0 0 10px rgba(239,71,111,0.3)'; }
        
        select.style.color = color; select.style.borderColor = color; select.style.backgroundColor = bg; select.style.boxShadow = shadow;
    }

    async function saveOpenPoints(sid, idx, pts) {
      await fetch('/api/submission-points/'+sid, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({questionIndex:parseInt(idx),points:parseInt(pts)})});
      const btn=event.target; const txt=btn.textContent; btn.textContent='‚úì'; setTimeout(()=>btn.textContent=txt,1000);
    }
    async function saveFinalReview() {
        await fetch('/api/save-review/'+submissionId, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({manualGrade:document.getElementById('finalGrade').value,teacherComment:document.getElementById('teacherComment').value})});
        alert('–ó–∞–ø–∞–∑–µ–Ω–æ!'); window.location.href='dashboard.html';
    }
    if (localStorage.getItem('dark') === 'true') document.body.classList.add('dark');

    // === STUDENT VIEW PROTECTION ===
    const currentUser = JSON.parse(localStorage.getItem('user'));
    if (currentUser && currentUser.role === 'student') {
        const reviewPanel = document.querySelector('.review-panel');
        if(reviewPanel) reviewPanel.style.display = 'none';

        const observer = new MutationObserver(() => {
            const pointBtns = document.querySelectorAll('.points-select + button');
            const pointSelects = document.querySelectorAll('.points-select');
            if (pointBtns.length > 0) {
                pointBtns.forEach(btn => btn.remove());
                pointSelects.forEach(sel => {
                    sel.disabled = true;
                    sel.style.border = 'none';
                    sel.style.background = 'transparent';
                    sel.style.appearance = 'none';
                    sel.style.fontWeight = 'bold';
                    const span = document.createElement('span');
                    span.textContent = sel.value + " —Ç.";
                    span.style.fontWeight = "bold";
                    sel.parentNode.replaceChild(span, sel);
                });
                observer.disconnect();
            }
        });
        observer.observe(document.getElementById('answers'), { childList: true, subtree: true });
    }
  </script>
</body>
</html>