<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8">
  <title>Преглед на отговор</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { background: linear-gradient(135deg,#667eea,#764ba2); }
    body.dark { background: #0d1117; }
    
    .open-answer p { margin: 5px 0; }
    /* Adjust textarea for read-only view */
    textarea[readonly] { background: #fdfdfd; color: #555; }
    body.dark textarea[readonly] { background: #1f2428; color: #a0a0a0; }
  </style>
</head>

<body>
  <div class="container">
    <h1 id="title">Зареждане...</h1>
    <div class="info-box" id="info"></div>
    <div id="answers"></div>
    <div style="text-align:center;">
      <a href="dashboard.html" class="back-btn btn">Обратно към дашборда</a>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const submissionId = params.get('id');

    fetch(`/api/submission/${submissionId}`)
      .then(r => r.json())
      .then(data => {
        document.getElementById('title').textContent = `${data.studentName} – ${data.testTitle}`;
        document.getElementById('info').innerHTML = `
          <strong>Клас:</strong> ${data.studentClass || '—'}<br>
          <strong>Предаден на:</strong> ${new Date(data.submittedAt).toLocaleString('bg-BG')}<br>
          <strong>Автоматична оценка:</strong> ${data.autoGrade || '—'}
        `;

        let savedPoints = {};
        try { savedPoints = JSON.parse(data.manualPoints || '{}'); } catch(e) {}

        const html = data.answers.map((a, i) => {
          const q = data.questions[i] || {};
          const maxPoints = q.points || 10;

          if (a.type === 'open') {
            const current = savedPoints[i] !== undefined ? savedPoints[i] : maxPoints;
            return `
              <div class="qblock">
                <h3>Въпрос ${i+1}: ${a.question} <small style="opacity:0.6">(до ${maxPoints} т.)</small></h3>
                <div class="open-answer">
                  <p><strong>Отговор на ученика:</strong></p>
                  <textarea readonly>${a.studentAnswer || ''}</textarea>
                  <div style="margin-top:15px; font-weight:bold; display:flex; align-items:center; justify-content:flex-end;">
                    <span style="margin-right:10px;">Дай точки (1–${maxPoints}):</span>
                    <select class="points-select" style="width:auto; margin:0 10px 0 0;" data-index="${i}">
                      ${Array.from({length: maxPoints}, (_, p) => p + 1)
                        .map(p => `<option value="${p}" ${p===current?'selected':''}>${p}</option>`).join('')}
                    </select>
                    <button class="btn green" style="margin:0;" onclick="saveOpenPoints(${submissionId},${i},this.previousElementSibling.value)">
                      Запази
                    </button>
                  </div>
                </div>
              </div>
            `;
          }

          const correct = Array.isArray(a.correctAnswer) ? a.correctAnswer.map(n => q.options?.[n] || n).join(', ') : q.options?.[a.correctAnswer] || '';
          const student = Array.isArray(a.studentAnswer) ? a.studentAnswer.map(n => q.options?.[n] || n).join(', ') : '—';
          const color = a.isCorrect ? '#06d6a0' : '#ef476f';
          
          return `
            <div class="qblock">
              <h3>Въпрос ${i+1}: ${a.question} <small style="opacity:0.6">(${maxPoints} т.)</small></h3>
              <p><strong>Верен:</strong> <span style="color:#00c851; font-weight:bold;">${correct}</span></p>
              <p><strong>Ученик:</strong> <span style="color:${color}; font-weight:bold;">${student}</span></p>
            </div>
          `;
        }).join('');
        document.getElementById('answers').innerHTML = html;
      });

    async function saveOpenPoints(submissionId, questionIndex, points) {
      const res = await fetch('/api/submission-points/' + submissionId, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ questionIndex: parseInt(questionIndex), points: parseInt(points) })
      });
      if ((await res.json()).success) {
        alert('Точките са запазени успешно!');
      } else {
        alert('Грешка при запазване');
      }
    }

    // Global Dark Mode Toggle
    if (localStorage.getItem('dark') === 'true') document.body.classList.add('dark');
    document.addEventListener('DOMContentLoaded', () => {
      let btn = document.getElementById('global-dark-toggle');
      if (!btn) {
        btn = document.createElement('button');
        btn.id = 'global-dark-toggle';
        btn.textContent = document.body.classList.contains('dark') ? '☀' : '☾';
        btn.style.cssText = 'position:fixed; top:15px; right:15px; z-index:99999; background:rgba(0,0,0,0.6); color:white; border:none; padding:8px 15px; border-radius:50px; font-size:18px; cursor:pointer; backdrop-filter:blur(5px); margin:0;';
        document.body.appendChild(btn);
        btn.onclick = () => {
          document.body.classList.toggle('dark');
          localStorage.setItem('dark', document.body.classList.contains('dark'));
          btn.textContent = document.body.classList.contains('dark') ? '☀' : '☾';
        };
      }
    });
  </script>
</body>
</html>