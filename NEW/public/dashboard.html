<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8">
  <title>Учителски дашборд</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Учителски дашборд</h1>
    <div id="tests" style="margin-top: 40px;">Зареждане...</div>
    <a href="index.html" class="back-btn btn">Обратно към таблото</a>
  </div>

  <script>
    fetch('/api/submissions')
      .then(r => r.json())
      .then(data => {
        const container = document.getElementById('tests');
        if (!data || data.length === 0) {
          container.innerHTML = '<div style="text-align:center; padding:40px; font-size:1.2rem; color:var(--text-muted);">Няма намерени резултати.</div>';
          return;
        }

        let html = '';
        const grouped = data.reduce((acc, s) => {
          const title = s.testTitle || 'Без заглавие';
          if (!acc[title]) acc[title] = [];
          acc[title].push(s);
          return acc;
        }, {});

        Object.keys(grouped).forEach(title => {
          const subs = grouped[title];
          html += `
            <div class="test-card" style="display:block; padding:0; overflow:hidden;">
              <div style="padding:20px; border-bottom:1px solid #eee; background:rgba(0,0,0,0.02);">
                 <h3 style="margin:0;">${title} <span style="font-weight:400; font-size:0.8em; opacity:0.7">(${subs.length} предадени)</span></h3>
              </div>
              <div style="overflow-x:auto;">
                <table style="margin:0; box-shadow:none; border-radius:0;">
                  <thead>
                    <tr>
                      <th>Ученик</th>
                      <th>Клас</th>
                      <th>Оценка</th>
                      <th>Дата</th>
                      <th>Действия</th>
                    </tr>
                  </thead>
                  <tbody>`;

          subs.forEach(s => {
            const displayGrade = (s.manualGrade && s.manualGrade !== '—') ? s.manualGrade : s.autoGrade;
            html += `
              <tr>
                <td><strong>${s.studentName || 'Анонимен'}</strong></td>
                <td>${s.studentClass || '—'}</td>
                <td>
                  <select class="grade-select" data-id="${s.submissionId}">
                    <option value="${displayGrade}" selected>${displayGrade}</option>
                    ${[2,3,4,5,6].map(g => `<option value="${g}">${g}</option>`).join('')}
                  </select>
                  <button class="btn green" onclick="saveGrade(${s.submissionId})" style="padding:6px 12px; font-size:13px; margin:0;">OK</button>
                </td>
                <td>${new Date(s.submittedAt).toLocaleString('bg-BG')}</td>
                <td>
                  <a href="submission.html?id=${s.submissionId}" class="btn dashboard" style="padding:6px 12px; font-size:13px; margin:0 5px;">Виж</a>
                  <button class="btn red" onclick="deleteSub(${s.submissionId})" style="padding:6px 12px; font-size:13px; margin:0;">Изтрий</button>
                </td>
              </tr>`;
          });

          html += `</tbody></table></div></div>`;
        });

        container.innerHTML = html;
      });

    async function saveGrade(id) {
      const select = document.querySelector(`select[data-id="${id}"]`);
      await fetch('/api/grade-manual/' + id, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ manualGrade: select.value })
      });
      alert('Оценката е запазена!');
    }

    async function deleteSub(id) {
      if (confirm('Сигурни ли сте?')) {
        await fetch('/api/submissions/' + id, { method: 'DELETE' });
        location.reload();
      }
    }
    
    if (localStorage.getItem('dark') === 'true') document.body.classList.add('dark');
  </script>
</body>
</html>