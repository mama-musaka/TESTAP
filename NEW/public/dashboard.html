<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8">
  <title>Учителски дашборд</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Only page-specific gradient override here */
    body { background: linear-gradient(135deg,#667eea,#764ba2); }
    body.dark { background: #0d1117; }
    
    header { 
      background: linear-gradient(135deg, #4361ee, #5d7bff); 
      color: white; 
      padding: 40px; 
      text-align: center; 
      font-size: 42px; 
      font-weight: bold; 
    }
    .no-data { text-align:center; padding:80px; font-size:26px; opacity: 0.6; }
  </style>
</head>
<body>
  <div class="container" style="padding:0;">
    <header>Учителски дашборд</header>
    <div class="main" style="padding: 50px;">
      <h2>Резултати от предадените тестове</h2>
      <div id="tests">Зареждане...</div>
      <a href="index.html" class="back-btn btn">Обратно към тестовете</a>
    </div>
  </div>

  <script>
    fetch('/api/submissions')
      .then(r => r.json())
      .then(data => {
        const container = document.getElementById('tests');

        if (!data || data.length === 0) {
          container.innerHTML = '<div class="no-data">Все още няма предадени тестове</div>';
          return;
        }

        let html = '';
        const grouped = data.reduce((acc, s) => {
          const title = s.testTitle || 'Без заглавие';
          if (!acc[title]) acc[title] = [];
          acc[title].push(s);
          return acc;
        }, {});

        Object.keys(grouped).forEach(title => {
          const subs = grouped[title];
          html += `
            <div class="test-card">
              <h3>${title} <small style="opacity:0.7; font-size:18px; margin-left: 10px;">(${subs.length} предавания)</small></h3>
              <table>
                <thead>
                  <tr>
                    <th>Ученик</th>
                    <th>Клас</th>
                    <th>Оценка</th>
                    <th>Предаден на</th>
                    <th>Действия</th>
                  </tr>
                </thead>
                <tbody>`;

          subs.forEach(s => {
            const displayGrade = (s.manualGrade && s.manualGrade !== '—') ? s.manualGrade : s.autoGrade;
            html += `
              <tr>
                <td><strong>${s.studentName || 'Анонимен'}</strong></td>
                <td>${s.studentClass || '—'}</td>
                <td>
                  <select class="grade-select" data-id="${s.submissionId}">
                    <option value="${displayGrade}" selected>${displayGrade}</option>
                    ${[2,3,4,5,6].map(g => `<option value="${g}">${g}</option>`).join('')}
                  </select>
                  <button class="btn btn-save" onclick="saveGrade(${s.submissionId})" style="padding: 8px 15px; margin: 0 5px;">Запази</button>
                </td>
                <td>${new Date(s.submittedAt).toLocaleString('bg-BG')}</td>
                <td>
                  <a href="submission.html?id=${s.submissionId}" class="btn btn-view" style="padding: 8px 15px; margin: 0 2px;">Преглед</a>
                  <button class="btn btn-delete" onclick="deleteSub(${s.submissionId})" style="padding: 8px 15px; margin: 0 2px;">Изтрий</button>
                </td>
              </tr>`;
          });

          html += `</tbody></table></div>`;
        });

        container.innerHTML = html;
      });

    async function saveGrade(id) {
      const select = document.querySelector(`select[data-id="${id}"]`);
      const grade = select.value;
      await fetch('/api/grade-manual/' + id, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ manualGrade: grade })
      });
      alert('Оценката е запазена!');
    }

    async function deleteSub(id) {
      if (confirm('Наистина ли искате да изтриете този резултат?')) {
        await fetch('/api/submissions/' + id, { method: 'DELETE' });
        location.reload();
      }
    }

    // Global Dark Mode Toggle
    if (localStorage.getItem('dark') === 'true') document.body.classList.add('dark');
    document.addEventListener('DOMContentLoaded', () => {
      let btn = document.getElementById('global-dark-toggle');
      if (!btn) {
        btn = document.createElement('button');
        btn.id = 'global-dark-toggle';
        btn.textContent = document.body.classList.contains('dark') ? '☀' : '☾';
        btn.style.cssText = 'position:fixed; top:15px; right:15px; z-index:99999; background:rgba(0,0,0,0.6); color:white; border:none; padding:8px 15px; border-radius:50px; font-size:18px; cursor:pointer; backdrop-filter:blur(5px); margin:0;';
        document.body.appendChild(btn);
        btn.onclick = () => {
          document.body.classList.toggle('dark');
          localStorage.setItem('dark', document.body.classList.contains('dark'));
          btn.textContent = document.body.classList.contains('dark') ? '☀' : '☾';
        };
      }
    });
  </script>
</body>
</html>