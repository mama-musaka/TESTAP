<!DOCTYPE html>
<html>
<head>
  <title>Take Test</title>
  <link rel="stylesheet" href="style.css">
  <style>
    textarea { width:100%; min-height:140px; padding:15px; margin-top:10px; font-size:16px; border:2px solid #ccc; border-radius:10px; resize:none; box-sizing:border-box; }
    textarea:focus { border-color:#4a90e2; box-shadow:0 0 10px rgba(74,144,226,0.3); outline:none; }
    .qblock { background:#f9f9f9; padding:20px; margin:20px 0; border-radius:10px; border-left:5px solid #4a90e2; }
    label { display:block; margin:12px 0; font-size:16px; }
  </style>
</head>
<body>
  <div class="container">
    <h1 id="title">Loading...</h1>
    <form id="quiz">
      <div id="questions"></div>
      <br>
      <button type="submit" class="green" style="font-size:18px;padding:15px 30px;">Submit & Grade</button>
    </form>

    <div id="result" style="display:none; margin-top:30px; padding:20px; background:#f0f8ff; border-radius:10px;"></div>
    <br><a href="index.html"><button>Back to Home</button></a>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    if (!id) { document.body.innerHTML = "<h1>No test selected</h1>"; }

    fetch('/api/tests/' + id)
      .then(r => r.json())
      .then(test => {
        document.getElementById('title').textContent = test.title;

        const html = test.questions.map((q, i) => {
          if (q.type === 'open') {
            return `<div class="qblock">
              <p><strong>Q${i+1}: ${q.text}</strong> <em style="color:#0066cc;">(Open answer)</em></p>
              <textarea name="q${i}" placeholder="Write your answer here..." required></textarea>
            </div>`;
          }
          if (q.type === 'multiple') {
            return `<div class="qblock">
              <p><strong>Q${i+1}: ${q.text}</strong> <em style="color:#e67e22;">(Multiple correct answers – check all that apply)</em></p>
              ${q.options.map((opt, j) => `
                <label><input type="checkbox" name="q${i}" value="${j}"> ${opt}</label>
              `).join('')}
            </div>`;
          }
          // single
          return `<div class="qblock">
            <p><strong>Q${i+1}: ${q.text}</strong></p>
            ${q.options.map((opt, j) => `
              <label><input type="radio" name="q${i}" value="${j}" required> ${opt}</label>
            `).join('')}
          </div>`;
        }).join('');

        document.getElementById('questions').innerHTML = html;
      })
      .catch(() => alert('Error loading test'));

    // SUBMIT — handles single, multiple, and open perfectly
    document.getElementById('quiz').onsubmit = async e => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const answers = {};

      // Group checkbox answers into arrays
      for (let [key, val] of fd) {
        if (answers[key]) {
          if (Array.isArray(answers[key])) answers[key].push(val);
          else answers[key] = [answers[key], val];
        } else {
          answers[key] = val;
        }
      }

      const response = await fetch('/api/grade/' + id, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(answers)
      });
      const result = await response.json();

      let out = `<h2>Multiple-choice correct: ${result.correct}/${result.total_mc}</h2>
                 <h1 style="color:${result.grade==='A'?'green':'red'}">Grade: ${result.grade}</h1>
                 <h3>Open questions for teacher: ${result.open_count}</h3>`;

      if (result.mistakes.length) {
        out += "<h3>Wrong answers:</h3>" + result.mistakes.map(m => `
          <div style="background:#ffebee;padding:15px;margin:10px 0;border-radius:8px;">
            <strong>${m.question}</strong><br>
            You: <span style="color:red">${m.your||'(nothing)'}</span><br>
            Correct: <span style="color:green">${m.correct}</span>
          </div>`).join('');
      }

      if (result.open_answers.length) {
        out += "<h3>Open answers:</h3>" + result.open_answers.map((a,i) => `
          <div style="background:#e8f5e9;padding:15px;margin:10px 0;border-radius:8px;">
            <strong>Q${i+1}:</strong><br>${a.replace(/\n/g,'<br>')||'<em>(empty)</em>'}
          </div>`).join('');
      }

      document.getElementById('result').innerHTML = out;
      document.getElementById('result').style.display = 'block';
      e.target.querySelector('button').disabled = true;
    };
  </script>
</body>
</html>