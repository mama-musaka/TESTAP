<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="utf-8">
  <title>Решаване на тест</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    body.dark { background: #0d1117; }

    header {
      background: linear-gradient(135deg, #4361ee, #5d7bff);
      color: white;
      padding: 25px;
      text-align: center;
      font-size: 28px;
    }
    .info-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f9fa;
      padding: 18px 25px;
      border-radius: 12px;
      margin-bottom: 25px;
    }
    .timer {
      font-size: 36px;
      font-weight: bold;
      color: #ef476f;
      background: white;
      padding: 12px 30px;
      border-radius: 50px;
      box-shadow: 0 8px 25px rgba(239,71,111,0.3);
    }
    .timer.warning { animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100% {transform:scale(1)} 50% {transform:scale(1.05)} }

    .progress-container {
      height: 14px;
      background: #e0e0e0;
      border-radius: 7px;
      overflow: hidden;
      margin: 20px 0;
    }
    .progress {
      height: 100%;
      background: linear-gradient(90deg, #06d6a0, #1fab89);
      width: 0%;
      transition: width 0.6s ease;
    }
    .student-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
    
    label { display: block; margin: 14px 0; font-size: 17px; cursor: pointer; }
    input[type="radio"], input[type="checkbox"] { transform: scale(1.3); margin-right: 12px; accent-color: #4361ee; }
    
    .btn-submit {
      display: block; width: 100%; padding: 18px; font-size: 22px;
      font-weight: bold; background: #06d6a0; color: white;
      border: none; border-radius: 16px; cursor: pointer; margin: 30px 0;
    }
    .btn-submit:hover { filter: brightness(110%); transform: translateY(-3px); }
  </style>
  
</head>
<body>
  <div class="container" style="padding:0;">
    <header id="title">Зареждане...</header>
    <div class="main" style="padding:30px;">
      <div class="info-bar">
        <div class="timer" id="timer">30:00</div>
        <div>Решени: <strong id="answered">0</strong> от <strong id="totalQ">0</strong></div>
      </div>

      <form id="quiz">
        <div class="student-inputs">
          <input type="text" id="studentName" placeholder="Име и фамилия" required>
          <input type="text" id="studentClass" placeholder="Клас (напр. 10А)" required>
        </div>

        <div class="progress-container">
          <div class="progress" id="progress"></div>
        </div>

        <div id="questions"></div>
        <button type="submit" class="btn-submit">Предай теста</button>
      </form>

      <div id="result" style="display:none; text-align:center; padding:80px 20px;">
        <h1 style="font-size:48px; color:#06d6a0; margin:0;">Тестът е предаден</h1>
        <a href="index.html" class="btn" style="display:inline-block; margin-top:50px; text-decoration:none; background:#4361ee;">
          Обратно към тестовете
        </a>
      </div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    if (!id) document.body.innerHTML = "<h1 style='color:white;text-align:center;margin-top:100px;'>Липсва тест!</h1>";

    let timeLeft = 30 * 60;
    const timerEl = document.getElementById('timer');
    const timerInterval = setInterval(() => {
      timeLeft--;
      const m = String(Math.floor(timeLeft / 60)).padStart(2, '0');
      const s = String(timeLeft % 60).padStart(2, '0');
      timerEl.textContent = `${m}:${s}`;
      
      if (timeLeft <= 300) timerEl.classList.add('warning');
      
      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        
        // LOCK QUESTIONS so answers cannot be changed
        const qDiv = document.getElementById('questions');
        qDiv.style.pointerEvents = 'none';
        qDiv.style.opacity = '0.6';
        
        alert('Времето изтече! Моля попълнете име и клас, за да предадете.');
        
        // Try to submit (will trigger validation if fields are empty)
        document.querySelector('.btn-submit').click();
      }
    }, 1000);

    fetch('/api/tests/' + id)
      .then(r => r.json())
      .then(test => {
        document.getElementById('title').textContent = test.title;
        document.getElementById('totalQ').textContent = test.questions.length;

        const html = test.questions.map((q, i) => {
          if (q.type === 'open') {
            return `<div class="qblock"><p><strong>Въпрос ${i+1}: ${q.text}</strong> <em style="color:#7209b7;">(текст)</em></p>
                    <textarea name="q${i}" required></textarea></div>`;
          }
          if (q.type === 'multiple') {
            const req = q.requiredCount || 2;
            return `<div class="qblock"><p><strong>Въпрос ${i+1}: ${q.text}</strong> <em style="color:#e63946;">(избери точно ${req})</em></p>
                    ${q.options.map((opt, j) => `<label><input type="checkbox" name="q${i}" value="${j}" onchange="limitCheckboxes(this,${req},${i})"> ${opt}</label>`).join('')}
                    <div id="warn${i}" style="color:#e63946; margin-top:8px; font-weight:bold;"></div></div>`;
          }
          return `<div class="qblock"><p><strong>Въпрос ${i+1}: ${q.text}</strong></p>
                  ${q.options.map((opt, j) => `<label><input type="radio" name="q${i}" value="${j}" required> ${opt}</label>`).join('')}</div>`;
        }).join('');
        document.getElementById('questions').innerHTML = html;

        document.querySelectorAll('input, textarea').forEach(el => {
          el.addEventListener('change', () => {
            const answered = new Set();
            document.querySelectorAll('[name^="q"]').forEach(inp => {
              if ((inp.type === 'radio' && inp.checked) || 
                  (inp.type === 'checkbox' && inp.checked) || 
                  (inp.tagName === 'TEXTAREA' && inp.value.trim())) {
                answered.add(inp.name);
              }
            });
            const percent = (answered.size / test.questions.length) * 100;
            document.getElementById('progress').style.width = percent + '%';
            document.getElementById('answered').textContent = answered.size;
          });
        });
      });

    function limitCheckboxes(cb, req, i) {
      const checked = document.querySelectorAll(`input[name="q${i}"]:checked`);
      if (checked.length > req) { cb.checked = false; }
      document.getElementById('warn'+i).textContent = checked.length === req ? 'Отлично!' : `Избрани: ${checked.length}/${req}`;
    }

    document.getElementById('quiz').onsubmit = async e => {
      e.preventDefault();
      
      // Extra check just to be safe
      const sName = document.getElementById('studentName').value.trim();
      const sClass = document.getElementById('studentClass').value.trim();
      if(!sName || !sClass) {
          alert('Моля, попълнете полетата за Име и Клас!');
          return;
      }

      clearInterval(timerInterval);

      const fd = new FormData(e.target);
      const answers = {};
      for (let [k, v] of fd) {
        if (answers[k]) {
          if (Array.isArray(answers[k])) answers[k].push(v);
          else answers[k] = [answers[k], v];
        } else answers[k] = v;
      }

      answers.studentName = sName;
      answers.studentClass = sClass;

      await fetch('/api/grade/' + id, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(answers)
      });

      document.getElementById('result').style.display = 'block';
      // Hide the form so they can't resubmit
      document.getElementById('quiz').style.display = 'none';
      document.querySelector('.info-bar').style.display = 'none';
      document.querySelector('.progress-container').style.display = 'none';
    };

    // Dark Mode
    if (localStorage.getItem('dark') === 'true') document.body.classList.add('dark');
    document.addEventListener('DOMContentLoaded', () => {
      let btn = document.getElementById('global-dark-toggle');
      if (!btn) {
        btn = document.createElement('button');
        btn.id = 'global-dark-toggle';
        btn.textContent = document.body.classList.contains('dark') ? '☀' : '☾';
        btn.style.cssText = 'position:fixed; top:15px; right:15px; z-index:99999; background:rgba(0,0,0,0.6); color:white; border:none; padding:8px 15px; border-radius:50px; font-size:18px; cursor:pointer; backdrop-filter:blur(5px); margin:0;';
        document.body.appendChild(btn);
        btn.onclick = () => {
          document.body.classList.toggle('dark');
          localStorage.setItem('dark', document.body.classList.contains('dark'));
          btn.textContent = document.body.classList.contains('dark') ? '☀' : '☾';
        };
      }
    });
  </script>
</body>
</html>