<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Създаване на тест</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Създаване на тест</h1>
    <input id="title" placeholder="Заглавие на теста"><br><br>
    <div id="questions"></div>
    <button onclick="addQuestion()">+ Добави въпрос</button>
    <button class="green" onclick="saveTest()">Запази теста</button>
    <a href="index.html"><button>Обратно</button></a>
  </div>

  <script>
    let count = 0;

    function addQuestion() {
      count++;
      const div = document.createElement('div');
      div.className = 'qblock';
      div.innerHTML = `
        <select class="qtype" onchange="toggleType(this)">
          <option value="single">Еднократен избор (1 верен)</option>
          <option value="multiple">Многократен избор (2 или 3 верни)</option>
          <option value="open">Отворен въпрос</option>
        </select><br><br>

        <input placeholder="Текст на въпроса" class="qtext"><br><br>

        <!-- Красиви радиобутони – показват се само при многократен избор -->
        <div class="multi-count-options" style="display:none; margin:15px 0; padding:15px; background:#fff8e1; border-radius:10px; border-left:5px solid #f39c12;">
          <strong>Брой верни отговори:</strong><br><br>
          <label style="font-size:16px; margin-right:25px;">
            <input type="radio" name="multi-count${count}" value="2" checked onchange="limitCheckboxes(this)">
            Точно 2 верни отговора
          </label>
          <label style="font-size:16px;">
            <input type="radio" name="multi-count${count}" value="3" onchange="limitCheckboxes(this)">
            Точно 3 верни отговора
          </label>
        </div>

        <div class="choice-options">
          ${[0,1,2,3].map(i => `
            <div style="margin:12px 0;">
              <input type="radio" name="correct${count}" value="${i}" class="single-correct">
              <input type="checkbox" class="multi-correct" value="${i}" style="display:none" onchange="enforceLimit(this)">
              <input placeholder="Отговор ${i+1}" class="opt" style="width:85%; margin-left:10px; padding:8px; border-radius:6px; border:1px solid #ccc;">
            </div>
          `).join('')}
        </div>

        <div class="open-hint" style="display:none; color:#0066cc; font-style:italic; margin:15px 0; padding:10px; background:#f0f8ff; border-radius:8px;">
          Ученикът ще пише свободен текст – ръчна проверка от учителя.
        </div>

        <button type="button" class="red" onclick="this.parentElement.remove()">Изтрий въпрос</button>
        <hr>
      `;
      document.getElementById('questions').appendChild(div);
    }

    function toggleType(select) {
      const block = select.parentElement;
      const multiDiv = block.querySelector('.multi-count-options');
      const choiceDiv = block.querySelector('.choice-options');
      const hint = block.querySelector('.open-hint');
      const radios = block.querySelectorAll('.single-correct');
      const checkboxes = block.querySelectorAll('.multi-correct');

      multiDiv.style.display = 'none';
      choiceDiv.style.display = 'none';
      hint.style.display = 'none';
      radios.forEach(r => { r.style.display = 'none'; r.checked = false; });
      checkboxes.forEach(c => { c.style.display = 'none'; c.checked = false; });

      if (select.value === 'open') {
        hint.style.display = 'block';
      } else if (select.value === 'single') {
        choiceDiv.style.display = 'block';
        radios.forEach(r => r.style.display = 'inline');
      } else if (select.value === 'multiple') {
        multiDiv.style.display = 'block';
        choiceDiv.style.display = 'block';
        checkboxes.forEach(c => c.style.display = 'inline');
        limitCheckboxes(block.querySelector('input[name^="multi-count"]:checked'));
      }
    }

    function enforceLimit(checkbox) {
      const block = checkbox.closest('.qblock');
      const selectedRadio = block.querySelector('input[name^="multi-count"]:checked');
      if (!selectedRadio) return;
      const max = parseInt(selectedRadio.value);

      const checked = block.querySelectorAll('.multi-correct:checked');
      if (checked.length > max) {
        checkbox.checked = false;
        alert(`Не можеш да избереш повече от ${max} верни отговора!`);
      }
    }

    function limitCheckboxes(radio) {
      if (!radio) return;
      const block = radio.closest('.qblock');
      const max = parseInt(radio.value);
      const checked = block.querySelectorAll('.multi-correct:checked');

      if (checked.length > max) {
        for (let i = max; i < checked.length; i++) {
          checked[i].checked = false;
        }
        alert(`Променено на ${max} верни – излишните отметки са премахнати.`);
      }
    }

    async function saveTest() {
      const title = document.getElementById('title').value.trim();
      if (!title) return alert('Въведете заглавие');

      const questions = [];
      let error = false;

      document.querySelectorAll('.qblock').forEach(block => {
        if (error) return;
        const text = block.querySelector('.qtext').value.trim();
        const type = block.querySelector('.qtype').value;
        if (!text) return;

        if (type === 'open') {
          questions.push({ text, type: 'open' });
          return;
        }

        const opts = Array.from(block.querySelectorAll('.opt')).map(o => o.value.trim()).filter(o => o);
        if (opts.length < 2) { error = true; alert('Минимум 2 отговора'); return; }

        if (type === 'single') {
          const sel = block.querySelector('input.single-correct:checked');
          if (!sel) { error = true; alert('Изберете един верен'); return; }
          questions.push({ text, type: 'single', options: opts, correct: parseInt(sel.value) });
        }

        if (type === 'multiple') {
          const required = parseInt(block.querySelector('input[name^="multi-count"]:checked').value);
          const checked = block.querySelectorAll('.multi-correct:checked');
          if (checked.length !== required) {
            error = true;
            alert(`Трябва точно ${required} маркирани верни отговора!`);
            return;
          }
          const correct = Array.from(checked).map(c => parseInt(c.value));
          questions.push({ text, type: 'multiple', options: opts, correct, requiredCount: required });
        }
      });

      if (error || questions.length === 0) return;

      await fetch('/api/tests', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, questions })
      });

      alert('Тестът е запазен успешно!');
      location.href = 'index.html';
    }

    addQuestion();
  </script>
</body>
</html>